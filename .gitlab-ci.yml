variables:
  RELEASE_NAME: "500EuroForSkier"
  AUTHOR: "bushtail"
  DLL_NAME: "500EuroForSkier.dll"
  OUTPUT_DIR: "SPT/user/mods"
  VERSION: "1.0.0"

stages:
  - build
  - package
  - release

build:
  stage: build
  image: mcr.microsoft.com/dotnet/sdk:9.0
  script:
    - dotnet restore
    - dotnet build -c Release
    - echo "Locating $DLL_NAME under bin/Releaseâ€¦"
    - DLL_PATH=$(find ${RELEASE_NAME}/bin/Release -type f -name "$DLL_NAME" | head -n1)
    - echo "${DLL_PATH}"
    - mkdir -p build_output/${OUTPUT_DIR}/${AUTHOR}-${RELEASE_NAME}
    - cp "$DLL_PATH" build_output/${OUTPUT_DIR}/${AUTHOR}-${RELEASE_NAME}/
  artifacts:
    paths:
      - build_output

package:
  stage: package
  image: alpine:latest
  dependencies:
    - build
  before_script:
    - apk add --no-cache zip
  script:
    - cd build_output
    - zip -r "../${RELEASE_NAME}_v${VERSION}.zip" .
  artifacts:
    paths:
      - "${RELEASE_NAME}_v${VERSION}.zip"

release:
  stage: release
  image: registry.gitlab.com/gitlab-org/cli:latest
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
  dependencies:
    - package
  script:
    - echo "Releasing version $VERSION"
  release:
    tag_name: "v${VERSION}"
    name: "${RELEASE_NAME} v${VERSION}"
    description: "Release of ${RELEASE_NAME} version ${VERSION}"
    ref: "$CI_COMMIT_SHA"
    assets:
      links:
        - name: "${RELEASE_NAME}_v${VERSION}.zip"
          url: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/jobs/artifacts/${CI_COMMIT_REF_NAME}/raw/${RELEASE_NAME}_v${VERSION}.zip?job=package"